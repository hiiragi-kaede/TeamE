<!DOCTYPE html>
<html>
  <head>
      <!-- Watanabe -->
    <title>Overlays Within Street View</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=__APIKEY__&callback=initMap&libraries=&v=weekly"
      defer
    ></script>

    <style type="text/css">
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 100%;
      }

      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #floating-panel {
        position: absolute;
        top: 10px;
        left: 25%;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
        text-align: center;
        font-family: "Roboto", "sans-serif";
        line-height: 30px;
        padding-left: 10px;
      }

      #floating-panel {
        margin-left: -100px;
      }
    </style>
    <script>
      "use strict";

      let panorama;
      let markers=[];
      let map;
      var PinIsVisible=true;
      var response;

      function initMap() {
        const astorPlace = {
            lat: 42.345573,
            lng: -71.098326
        }; // Set up the map

        map = new google.maps.Map(document.getElementById('map'), {
        center: astorPlace,
        zoom: 18,
        streetViewControl: true,
        });

        const cafeMarker = new google.maps.Marker({
          position: {
            lat: 42.3456,
            lng: -71.0984
          },
          map,
          icon:
            "img/楽天パンダ.png",
          title: "Cafe",
          url:'https://www.rakuten.co.jp/'
        });
        markers.push(cafeMarker);

        const bankMarker = new google.maps.Marker({
          position: {
            lat: 42.3456,
            lng: -71.098,
          },
          map,
          icon:
            "img/楽天パンダ.png",
          title: "Bank",
          url:'https://www.rakuten.co.jp/'
        });
        markers.push(bankMarker);

        const busMarker = new google.maps.Marker({
          position: {
            lat: 42.345,
            lng: -71.098
          },
          map,
          icon:
            "img/楽天パンダ.png",
          title: "Bus Stop",
          url:'https://www.rakuten.co.jp/'
        }); // We get the map's default panorama and set up some defaults.
        // Note that we don't yet set it visible.
        markers.push(busMarker);


        //Meisho Kanaomi
        for(let i=0; i<markers.length; i++){
            console.log(markers[i]);
            google.maps.event.addListener(markers[i], 'click', (function(url){
        return window.open(markers[i].url);}))}
        
        
        
        //function(){ location.href = url; };
        //})(markers[i].url));
        //}

        panorama = map.getStreetView();
        panorama.setPosition(astorPlace);
        panorama.setPov(
          /** @type {google.maps.StreetViewPov} */
          {
            heading: 265,
            pitch: 0
          }
        );
        panorama.setVisible(true);

        //Meisho Kanaomi
        var tmp_lat = panorama.getPosition().lat
        var tmp_log = panorama.getPosition().log
        console.log(tmp_lat)
        console.log(tmp_log)
      }

      function toggleStreetView() {
        const toggle = panorama.getVisible();

        if (toggle == false) {
          panorama.setVisible(true);
          showMarkers();
        } else {
          panorama.setVisible(false);
          hideMarkers();
        }
      }

      function togglePins() {
        const toggle = panorama.getVisible();

        //パノラマ状態じゃないときは変更しない
        if(toggle == false){
            return;
        }

        if (PinIsVisible == false) {
          showMarkers();
          PinIsVisible = true;
        } else {
          hideMarkers();
          PinIsVisible = false;
        }
      }

      function setMapOnAll(map){
          for(let i=0; i<markers.length; i++){
              markers[i].setMap(map);
          }
      }

      //markerを非表示にする
      function hideMarkers(){
          setMapOnAll(null);
      }
      //markerを表示する
      function showMarkers(){
          setMapOnAll(map);
      }

      //markerを消去する
      function deleteMarkers(){ 
          hideMarkers();
          markers=[];
      }

    </script>
  </head>
  <body>
    <div id="floating-panel">
      <input
        type="button"
        value="Toggle Street View"
        onclick="toggleStreetView();"
      />
      <input
        type="button"
        value="Toggle Pins"
        onclick="togglePins();"
      />
    </div>
    <div id="map"></div>

    <!-- 2020/09/04 Ryo Omae -->
    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->

    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>

    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-database.js"></script>
  
    // TODO: Replace the following with your app's Firebase project configuration

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyD6VaOrWy9iANa9hJymbptL7YDC7PKZ6hM",
    authDomain: "rakuten-intern2020-b5.firebaseapp.com",
    databaseURL: "https://rakuten-intern2020-b5.firebaseio.com",
    projectId: "rakuten-intern2020-b5",
    storageBucket: "rakuten-intern2020-b5.appspot.com",
    messagingSenderId: "677223095236",
    appId: "1:677223095236:web:683056011b10dc74c5e291"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);


</script>

<script>
    // Ryo Omae 2020/09/04
    var database = firebase.database();

    var contentData;
    var contentTempData;
    var contentRef = database.ref('content/');

    //Ryota Watanabe 2020/09/07
    //常に実行される。DBが更新されたときに呼び出される(更新処理に使う)
    contentRef.on('value', function(snapshot) {

        deleteMarkers();
        contentData = snapshot.val()
        SetMarkersFromDB();
    })

    contentRef.once('value').then(function(snapshot) {
        contentTempData = snapshot.val()
    })


    function SetMarkersFromDB(){
      var contentString = '<div id="content">'+
      '<h1 id="firstHeading" class="firstHeading">Uluru</h1>'+
      '<div id="bodyContent">'
      '<p>Attribution: Uluru, <a href="https://en.wikipedia.org/w/index.php?title=Uluru&oldid=297882194">'+
      'https://en.wikipedia.org/w/index.php?title=Uluru</a> '+
      '(last visited June 22, 2009).</p>'+
      '</div>'+
      '</div>';;

      var infowindow = new google.maps.InfoWindow({
        content: contentString
      });

      console.log(contentData);
      Object.keys(contentData).forEach(function(key){
        const newMarker = new google.maps.Marker({
        position: {
          lat: contentData[key]["lat"],
          lng: contentData[key]["lng"]
        },
        map,
        icon:
          "../img/tokyo_2021.png",
        title: contentData[key]["title"],
        url:contentData[key]["url"]
        });
        markers.push(newMarker);
      });
      

      //Meisho Kanaomi
      for(let i=0; i<markers.length; i++){
          //console.log(markers[i]);
          // google.maps.event.addListener(markers[i], 'click', (function(url){
          // return window.open(markers[i].url);}))

          markers[i].addListener('click',function(){
            infowindow.open(map,markers[i]);
            console.log("open info_window");
          });
      }
    }

    
</script>
</body>
</html>